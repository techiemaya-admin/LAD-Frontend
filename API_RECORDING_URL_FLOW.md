## Call Log Recording URL API Flow Documentation

### API Endpoints Called When Clicking a Log

#### 1. **Fetch Call Log Details**
```
GET /api/voice-agent/calllogs/{id}
```

**Response Structure:**
```json
{
  "success": true,
  "data": {
    "call_log_id": "uuid-or-id",
    "id": "call-id",
    "call_id": "call-id",
    "voice_call_id": "voice-call-id",
    "agent_name": "Agent Name",
    "lead_first_name": "Lead",
    "lead_last_name": "Name",
    "direction": "inbound|outbound",
    "status": "completed|failed|ended",
    "started_at": "2026-01-20T10:30:00Z",
    "duration_seconds": 120,
    "cost": 0.50,
    "call_cost": 0.50,
    "batch_id": "batch-id",
    "batch_status": "completed",
    "lead_category": "Hot Lead",
    "signed_recording_url": "https://storage.googleapis.com/...",
    "recording_url": "https://storage.googleapis.com/...",
    "call_recording_url": "gs://bucket/path/to/recording.wav",
    "transcripts": "[{\"speaker\": \"agent\", \"text\": \"...\", \"timestamp\": 0}]",
    "transcriptions": "...",
    "analysis": {
      "sentiment": "positive",
      "summary": "...",
      "key_points": ["...", "..."]
    }
  }
}
```

#### 2. **Fetch Signed Recording URL** (Optional)
```
GET /api/voice-agent/calls/{callId}/recording-signed-url
```

**Response:**
```json
{
  "success": true,
  "signed_url": "https://storage.googleapis.com/bucket/path?signature=..."
}
```

---

### Recording URL Priority (Fallback Chain)

The modal checks URLs in this order:

1. **Signed URL from dedicated endpoint** 
   - Fetched from `/api/voice-agent/calls/{callId}/recording-signed-url`
   - Most secure option with expiration

2. **signed_recording_url** (from call log response)
   - Pre-signed URL included in main response
   - Already authenticated

3. **recording_url** (from call log response)
   - Standard recording URL format
   - May be GCS, HTTPS, or signed URL

4. **call_recording_url** (from call log response)
   - Alternative field name for recording URL
   - Fallback format: `gs://bucket/path/to/recording.wav`

---

### Recording URL Types

#### **GCS URL Format**
```
gs://bucket-name/path/to/recording.wav
```
- Native Google Cloud Storage path
- Requires authentication to access
- Converted to HTTPS by export utility

#### **HTTPS URL Format**
```
https://storage.googleapis.com/bucket-name/path/to/recording.wav
```
- Publicly accessible if bucket is public
- Signed URL with query parameters included
- Example: `https://storage.googleapis.com/bucket?signature=abc123&expires=...`

#### **Signed URL Format**
```
https://storage.googleapis.com/bucket/path?X-Goog-Algorithm=...&X-Goog-Credential=...&X-Goog-Date=...&X-Goog-Expires=...&X-Goog-SignedHeaders=...&X-Goog-Signature=...
```
- Temporary access token
- Automatically generated by `/api/voice-agent/calls/{callId}/recording-signed-url`
- Expires after set time period

---

### Export Utility Processing

When exporting logs, the URLs are processed:

#### **Original URL → GCP HTTPS**
```typescript
gs://my-bucket/calls/recording.wav
↓
https://storage.googleapis.com/my-bucket/calls/recording.wav
```

#### **GCP HTTPS → Proxy URL**
```typescript
https://storage.googleapis.com/my-bucket/calls/recording.wav
↓
http://localhost:3000/api/recording-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fmy-bucket%2Fcalls%2Frecording.wav
```

---

### Data Flow Diagram

```
Click Call Log
    ↓
GET /api/voice-agent/calllogs/{id}
    ↓
Response includes:
  - signed_recording_url (preferred)
  - recording_url
  - call_recording_url
  - transcripts/transcriptions
  - analysis
    ↓
If signed_recording_url not in response:
  GET /api/voice-agent/calls/{callId}/recording-signed-url
    ↓
Set audio player with recording URL
Display transcripts, analysis, messages
```

---

### Fields Available for Export

| Field | Source | Format | Example |
|-------|--------|--------|---------|
| `signed_recording_url` | API response | HTTPS/Signed | `https://storage.googleapis.com/...` |
| `recording_url` | API response | HTTPS/Signed/GCS | `https://storage.googleapis.com/...` |
| `call_recording_url` | API response | GCS/HTTPS | `gs://bucket/path` |
| Recording URL (Export) | Converted | GCP HTTPS | `https://storage.googleapis.com/bucket/path` |
| Recording Proxy URL (Export) | Generated | Proxy | `http://localhost:3000/api/recording-proxy?url=...` |

---

### Error Handling

If recording URL fetch fails:
1. Try signed URL endpoint
2. Fall back to `signed_recording_url` from main response
3. Fall back to `recording_url` from main response
4. Fall back to `call_recording_url` from main response
5. If all fail, audio player shows "No recording available"

```typescript
// Current logic in call-log-modal.tsx:565
const signedRes = await apiGet<{ success: boolean; signed_url?: string }>(
  `/api/voice-agent/calls/${callId}/recording-signed-url`
);
if (signedRes?.success && signedRes?.signed_url) {
  audioUrl = signedRes.signed_url;
}
if (!audioUrl && l?.signed_recording_url) audioUrl = l.signed_recording_url;
if (!audioUrl && l?.recording_url) audioUrl = l.recording_url;
if (!audioUrl && l?.call_recording_url) audioUrl = l.call_recording_url;
```
